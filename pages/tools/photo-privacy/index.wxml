<view class="container">
  <!-- 隐藏的Canvas用于处理图片 -->
  <canvas 
    type="2d" 
    id="canvas" 
    style="position: fixed; left: -9999px; width: 1px; height: 1px;"
  ></canvas>

  <!-- 处理结果（优先显示在顶部） -->
  <view class="result-section" wx:if="{{showResult}}">
    <!-- 成功提示 -->
    <view class="result-header">
      <view class="result-icon-wrapper">
        <t-icon name="check" size="60rpx" color="#fff" />
      </view>
      <view class="result-info">
        <text class="result-title">隐私信息已清除</text>
        <text class="result-subtitle">照片现在可以安全分享了</text>
      </view>
    </view>

    <!-- 图片对比 -->
    <view class="result-compare">
      <view class="compare-item" bindtap="previewOriginal">
        <image src="{{imagePath}}" mode="aspectFill" />
        <view class="compare-label">
          <t-icon name="close-circle" size="28rpx" color="#e34d59" />
          <text>原图</text>
        </view>
      </view>
      <view class="compare-arrow">
        <t-icon name="arrow-right" size="48rpx" color="#2d6a7a" />
      </view>
      <view class="compare-item safe" bindtap="previewProcessed">
        <image src="{{processedPath}}" mode="aspectFill" />
        <view class="compare-label safe">
          <t-icon name="check-circle" size="28rpx" color="#00a870" />
          <text>安全</text>
        </view>
      </view>
    </view>

    <!-- 清除详情 -->
    <view class="cleared-info">
      <view class="cleared-title">
        <t-icon name="info-circle" size="32rpx" color="#2d6a7a" />
        <text>已清除的信息</text>
      </view>
      <view class="cleared-list">
        <view class="cleared-item" wx:if="{{riskStatus.location}}">
          <t-icon name="location" size="32rpx" color="#00a870" />
          <text>位置信息</text>
        </view>
        <view class="cleared-item" wx:if="{{riskStatus.datetime}}">
          <t-icon name="time" size="32rpx" color="#00a870" />
          <text>拍摄时间</text>
        </view>
        <view class="cleared-item" wx:if="{{riskStatus.device}}">
          <t-icon name="mobile" size="32rpx" color="#00a870" />
          <text>设备信息</text>
        </view>
        <view class="cleared-item" wx:if="{{!riskStatus.location && !riskStatus.datetime && !riskStatus.device}}">
          <t-icon name="check-circle" size="32rpx" color="#00a870" />
          <text>图片已重新编码</text>
        </view>
      </view>
    </view>

    <!-- 操作按钮组 -->
    <view class="result-actions">
      <view class="action-btn primary" bindtap="saveImage">
        <t-icon name="download" size="40rpx" color="#fff" />
        <text>保存到相册</text>
      </view>
      <view class="action-btn secondary" bindtap="shareImage">
        <t-icon name="share" size="40rpx" color="#2d6a7a" />
        <text>分享给好友</text>
      </view>
    </view>

    <!-- 继续处理 -->
    <view class="continue-btn" bindtap="reset">
      <text>处理其他照片</text>
    </view>
  </view>

  <!-- 选择图片区域（未处理时显示） -->
  <view class="upload-section" wx:if="{{!showResult}}">
    <view class="upload-box" bindtap="chooseImage">
      <view class="upload-icon-wrapper" wx:if="{{!imagePath}}">
        <t-icon name="camera" size="60rpx" color="#3d7a99" />
      </view>
      <!-- 图片预览 -->
      <view class="preview-image" wx:if="{{imagePath}}" catchtap="previewOriginal">
        <image src="{{imagePath}}" mode="aspectFit" />
      </view>
      <view class="upload-title">{{imagePath ? '点击重新选择' : '选择要保护的照片'}}</view>
      <view class="upload-desc" wx:if="{{!imagePath}}">点击选择照片以移除隐藏的元数据</view>
      <view class="upload-btn" wx:if="{{!imagePath}}">
        <text>选择照片</text>
      </view>
    </view>
  </view>

  <!-- 安全提示（未处理时显示） -->
  <view class="security-notice" wx:if="{{!showResult}}">
    <view class="notice-icon">
      <t-icon name="secured" size="40rpx" color="#3d7a99" />
    </view>
    <view class="notice-content">
      <text class="notice-title">本地处理：</text>
      <text class="notice-text">您的照片不会离开设备。我们在本地离线处理，确保最高安全性。</text>
    </view>
  </view>

  <!-- 隐私风险检测（未处理时显示） -->
  <view class="risks-section" wx:if="{{!showResult}}">
    <view class="risks-header">
      <text class="risks-title">隐私风险检测</text>
      <text class="risks-badge {{imagePath ? (hasPrivacyInfo ? 'danger' : 'safe') : ''}}">
        {{imagePath ? (hasPrivacyInfo ? '发现风险' : '无风险') : '待分析'}}
      </text>
    </view>

    <!-- 风险项列表 -->
    <view class="risk-list">
      <!-- 遍历检测到的EXIF项 -->
      <block wx:for="{{exifItems}}" wx:key="type">
        <view class="risk-item {{item.hasValue && item.type !== 'size' ? 'has-risk' : ''}}">
          <view class="risk-icon {{item.hasValue && item.type !== 'size' ? 'risk' : ''}}">
            <t-icon 
              name="{{item.icon}}" 
              size="40rpx" 
              color="{{item.hasValue && item.type !== 'size' ? '#e34d59' : '#3d7a99'}}" 
            />
          </view>
          <view class="risk-content">
            <view class="risk-name">{{item.label}}</view>
            <view class="risk-value {{item.hasValue && item.type !== 'size' ? 'detected' : ''}}">
              {{item.value}}
            </view>
          </view>
          <view class="risk-status">
            <block wx:if="{{!imagePath}}">
              <t-icon name="minus-circle" size="40rpx" color="#b8c9d0" />
            </block>
            <block wx:elif="{{item.hasValue && item.type !== 'size'}}">
              <t-icon name="error-circle-filled" size="40rpx" color="#e34d59" />
            </block>
            <block wx:else>
              <t-icon name="check-circle-filled" size="40rpx" color="#00a870" />
            </block>
          </view>
        </view>
      </block>

      <!-- 如果没有选择图片，显示占位项 -->
      <block wx:if="{{!imagePath}}">
        <view class="risk-item">
          <view class="risk-icon">
            <t-icon name="location" size="40rpx" color="#3d7a99" />
          </view>
          <view class="risk-content">
            <view class="risk-name">位置信息</view>
            <view class="risk-value">GPS坐标、海拔和地图标签</view>
          </view>
          <view class="risk-status">
            <t-icon name="minus-circle" size="40rpx" color="#b8c9d0" />
          </view>
        </view>
        <view class="risk-item">
          <view class="risk-icon">
            <t-icon name="time" size="40rpx" color="#3d7a99" />
          </view>
          <view class="risk-content">
            <view class="risk-name">拍摄时间</view>
            <view class="risk-value">精确时间戳和编辑历史</view>
          </view>
          <view class="risk-status">
            <t-icon name="minus-circle" size="40rpx" color="#b8c9d0" />
          </view>
        </view>
        <view class="risk-item">
          <view class="risk-icon">
            <t-icon name="mobile" size="40rpx" color="#3d7a99" />
          </view>
          <view class="risk-content">
            <view class="risk-name">设备信息</view>
            <view class="risk-value">相机型号、镜头参数和序列号</view>
          </view>
          <view class="risk-status">
            <t-icon name="minus-circle" size="40rpx" color="#b8c9d0" />
          </view>
        </view>
      </block>
    </view>
  </view>

  <!-- 底部说明 -->
  <view class="bottom-tips" wx:if="{{!showResult}}">
    <text>此工具移除隐藏的EXIF元数据以防止追踪。\n您的原始照片将保持不变。</text>
  </view>

  <!-- 操作按钮（未处理时显示） -->
  <view class="action-section" wx:if="{{!showResult}}">
    <view class="action-bg"></view>
    <view 
      class="main-btn {{(!imagePath || processing) ? 'disabled' : ''}}" 
      bindtap="removeExif"
    >
      <t-icon name="delete" size="40rpx" color="#fff" />
      <text>{{processing ? '处理中...' : '清除隐私信息'}}</text>
    </view>
  </view>
</view>
