# 订阅消息推送测试指南

## 一、前置准备

### 1. 配置云开发环境

1. **登录微信公众平台**
   - 访问 https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **开通云开发**
   - 进入小程序后台 → 左侧菜单「云开发」
   - 点击「开通」创建云开发环境
   - 记录环境ID（如：`cloud1-xxx`）

3. **配置云开发环境ID**
   - 在 `app.js` 中修改：
   ```javascript
   wx.cloud.init({
     env: 'your-env-id', // 替换为你的环境ID
     traceUser: true
   });
   ```

4. **上传云函数**
   - 在微信开发者工具中，右键点击 `cloud/sendAnniversaryMsg` 文件夹
   - 选择「上传并部署：云端安装依赖」
   - 等待上传完成

### 2. 配置订阅消息模板

1. **获取模板ID**
   - 小程序后台 → 「订阅消息」→ 「公共模板库」
   - 搜索「日期提醒」或「纪念日」
   - 选择模板并添加到「我的模板」
   - 复制模板ID（已配置：`_sxu2b5a-gmqPcBSbtJVn3sdJy7r70qkkaKEynCQVxY`）

2. **确认模板字段**
   - 模板字段需要匹配：
     - `thing1`: 纪念日名称
     - `date2`: 日期
     - `phrase3`: 倒计时文本

## 二、测试方法

### 方法一：真实日期测试（推荐）

1. **添加测试纪念日**
   - 进入纪念日管家页面
   - 点击添加按钮
   - 添加一个日期为「明天」的纪念日（剩余1天）
   - 或添加「3天后」、「7天后」的纪念日

2. **触发推送**
   - 进入纪念日列表页
   - 系统会自动检查并发送推送
   - 查看微信消息通知

### 方法二：使用测试按钮（开发调试）

在列表页添加测试按钮，可以立即测试推送功能。

### 方法三：修改系统时间（不推荐）

在代码中临时修改日期计算逻辑，模拟剩余天数。

## 三、调试技巧

### 1. 查看控制台日志

在微信开发者工具的控制台中查看：
- `订阅消息授权结果` - 授权状态
- `订阅消息发送成功` - 发送结果
- `订阅消息发送失败` - 错误信息

### 2. 检查云函数日志

1. 小程序后台 → 「云开发」→ 「云函数」
2. 找到 `sendAnniversaryMsg` 函数
3. 查看「日志」标签页

### 3. 常见问题

**问题1：提示"云开发未初始化"**
- 解决：检查 `app.js` 中是否正确初始化云开发
- 确认环境ID是否正确

**问题2：提示"模板ID不存在"**
- 解决：检查模板ID是否正确
- 确认模板是否已添加到「我的模板」

**问题3：提示"用户未授权"**
- 解决：用户需要点击授权按钮
- 订阅消息需要用户主动授权，不能强制

**问题4：提示"今天已发送过"**
- 解决：这是正常行为，避免重复发送
- 如需重复测试，清除本地存储：
  ```javascript
  // 在控制台执行
  wx.clearStorageSync()
  ```

## 四、测试检查清单

- [ ] 云开发环境已创建
- [ ] 云函数已上传并部署
- [ ] 订阅消息模板已配置
- [ ] 模板ID已更新到代码中
- [ ] 用户已授权订阅消息
- [ ] 测试纪念日日期设置正确（剩余1/3/7天）
- [ ] 控制台无错误信息
- [ ] 云函数日志显示成功

## 五、快速测试代码

在列表页添加测试按钮，可以立即触发推送测试：

```javascript
// 在 index.js 中添加测试方法
testNotification() {
  // 创建一个测试纪念日
  const testItem = {
    id: 'test_' + Date.now(),
    name: '测试纪念日',
    date: dateUtils.formatDate(new Date(Date.now() + 1 * 24 * 60 * 60 * 1000)), // 明天
    type: 'custom',
    note: '测试用'
  };
  
  // 直接调用推送方法
  this.sendNotificationMessage(testItem, 1);
}
```
